#!/bin/bash

args=$@
if [ "${#args}" -lt 2 ]; then
  echo "Usage: `basename $0` ENUM_NAME FILES_TO_SCAN" >&2
  exit 65
fi

BS="${BASH_SOURCE[0]}";RL="readlink";([[ `uname -s`=='Darwin' ]] || RL="$RL -f")
  while([ -h "${BS}" ]) do BS=`$RL "${BS}"`; done
  N="/dev/null";pushd .>$N;cd `dirname ${BS}`>$N;BS=`pwd`;popd>$N

ENUM_NAME=$1; shift

# (we preprocess it first, ignoring warnings/include errors, so that it
# normalizes newlines, expands known macros, and removes comments.)
KV_KEYS=( $( gcc -I. -I"${BS}" -I.. -Iinc -Isrc/inc -P -E $@ 2>/dev/null \
  | grep -E '_gx_e?log\s*\('                                             \
  | grep -E -o 'K[a-z_][a-z0-9_]*'                                       \
  | sort -u ) )

#if [ ${#KV_KEYS[@]} -lt 1 ]; then
#  echo "Warning: no keys found. Enum not emitted." >&2
#else
  echo "typedef enum ${ENUM_NAME} {"
  printf "    %s,\n" ${KV_KEYS[@]}
  echo "} ${ENUM_NAME};"
#fi
